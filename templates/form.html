<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å®¢æµæ€åŠ¿æ§åˆ¶å°</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      display: grid;
      grid-template-columns: 200px 1fr;
      height: 100vh;
      margin: 0;
      font-family: "Microsoft YaHei", sans-serif;
    }
    .sidebar {
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 20px;
    }
    .sidebar a {
      display: block;
      margin-bottom: 10px;
      padding: 10px;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      color: #2c7be5;
      background: #e6f0ff;
    }
    .sidebar a.active {
      background: #2c7be5;
      color: white;
    }
    .container {
      padding: 20px;
      overflow-y: auto;
    }
    .section { display: none; }
    .active-section { display: block; }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .card-title { font-weight: bold; margin-bottom: 10px; }
    .highlight { font-size: 24px; font-weight: bold; color: #2c7be5; }
    .subtext { color: #888; font-size: 14px; }
    .badge-red { background: #f56c6c; color: white; padding: 2px 6px; border-radius: 8px; font-size: 12px; }
    .badge-blue { background: #409eff; color: white; padding: 2px 6px; border-radius: 8px; font-size: 12px; }
    .card-pink { background: #fdecec; }
    .card-blue { background: #e9f3fc; }
    .card-orange { background: #fff5e5; }
    .card-lightpink { background: #fef0ef; }
    .warning-card { margin-top: 10px; padding: 10px; border-radius: 8px; }
    .warning-red { background: #fdecec; border-left: 4px solid red; }
    .warning-blue { background: #e9f3fc; border-left: 4px solid #409eff; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h5>å¯¼èˆª</h5>
    <a id="nav-dashboard" onclick="switchSection('dashboard')" class="active">ğŸ“Š æ§åˆ¶å°</a>
    <a id="nav-list" onclick="switchSection('list')">ğŸ“‹ äººæµé‡åˆ—è¡¨</a>
    <a id="nav-map" onclick="switchSection('map')">ğŸš‡ è½¦ç«™çƒ­åŠ›å›¾</a>

  </div>

  <div class="container">
    <!-- æ§åˆ¶å°æ¨¡å— -->
    <div id="dashboard" class="section active-section">
      <h4>ğŸ“Š æ§åˆ¶å°ä¸»è§†å›¾</h4>
      <div class="grid">
        <div class="card card-pink">
          <div class="card-title">24å°æ—¶è¥¿ç«™ä¸œå¹¿åœºå‡ºç«™å£é—¸æœº1<br>ç¬¬ 1 çº§å®¢æµé¢„è­¦ <span class="badge-red">3 åˆ†é’Ÿè§¦å‘</span></div>
          <div class="highlight">é¢„è®¡ 200 äºº</div>
          <div class="subtext">é¢„è®¡ç–æ•£æ—¶é—´ï¼š8 åˆ†é’Ÿ</div>
        </div>
        <div class="card card-blue">
          <div class="card-title">24å°æ—¶è¥¿ç«™ä¸œå¹¿åœºå‡ºç«™å£é—¸æœº2<br>ç¬¬ 2 çº§å®¢æµé¢„è­¦ <span class="badge-blue">2 åˆ†é’Ÿè§¦å‘</span></div>
          <div class="highlight">é¢„è®¡ 100 äºº</div>
          <div class="subtext">é¢„è®¡ç–æ•£æ—¶é—´ï¼š6 åˆ†é’Ÿ</div>
        </div>
      </div>

      <h5>å‡ºç§Ÿè½¦ä¸Šå®¢æµé‡é¢„ä¼°</h5>
      <div class="grid">
        <div class="card card-orange">
          <div class="card-title">ğŸš– å‡ºç§Ÿè½¦</div>
          <div class="highlight">ç­‰è½¦ 113 å°</div>
          <div class="subtext">å®¢æµé¢„æµ‹ 305 äºº</div>
        </div>
        <div class="card card-lightpink">
          <div class="card-title">ğŸš— ç½‘çº¦è½¦</div>
          <div class="highlight">ç­‰è½¦ 245 å°</div>
          <div class="subtext">å®¢æµé¢„æµ‹ 750 äºº</div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="card-title">ğŸ‘¥ å®¢æµæ€§åˆ«æ¯”ä¾‹</div>
          <div id="pieChart" style="height: 300px;"></div>
        </div>
        <div class="card">
          <div class="card-title">ğŸ“ˆ 24å°æ—¶äººæµè¶‹åŠ¿</div>
          <div id="lineChart" style="height: 300px;"></div>
          <div class="warning-card warning-red">
            â° è·ç¦»ä¸‹ä¸€æ¬¡æ‹¥å µè¿˜æœ‰ <strong>7å°æ—¶</strong>ï¼Œé¢„è®¡750äººï¼Œç–æ•£æ—¶é—´8åˆ†é’Ÿ
          </div>
          <div class="warning-card warning-blue">
            â° è·ç¦»ç¬¬äºŒæ¬¡æ‹¥å µè¿˜æœ‰ <strong>18å°æ—¶</strong>ï¼Œé¢„è®¡650äººï¼Œç–æ•£æ—¶é—´6åˆ†é’Ÿ
          </div>
        </div>
      </div>
    </div>
    <!-- è½¦ç«™çƒ­åŠ›å›¾æ¨¡å— -->
    <div id="map" class="section container-fluid">
        <h4 class="my-3">ğŸš‡ è½¦ç«™çƒ­åŠ›å›¾</h4>
        <div class="card">
        <div class="card-title">æ¸©å·å—ç«™çƒ­åŠ›å›¾ï¼ˆç¤ºæ„ï¼‰</div>
        <img src="/static/images/heatmap.png" alt="è½¦ç«™çƒ­åŠ›å›¾" class="img-fluid rounded shadow">
        </div>
    </div>
    
    <!-- äººæµé‡åˆ—è¡¨æ¨¡å— -->
    <!-- ä¿ç•™å·²æœ‰é›†æˆåçš„æ¨¡å— -->
    <div id="list" class="section container-fluid">
  <h4 class="my-3">ğŸ“‹ äººæµé‡åˆ—è¡¨</h4>

  <div class="row g-2 align-items-center mb-3">
    <div class="col-md-3">
      <input type="text" id="searchInput" class="form-control" placeholder="è¯·è¾“å…¥å®¢æµç‚¹ä½">
    </div>
    <div class="col-md-2">
      <input type="date" id="dateInput" class="form-control">
    </div>
    <div class="col-md-2">
      <select id="clockInput" class="form-select">
        <script>
          const hours = [...Array(24).keys()].map(i => `${i.toString().padStart(2, '0')}:00`);
          document.write(hours.map(h => `<option value="${h}">${h}</option>`).join(''));
        </script>
      </select>
    </div>
    <div class="col-auto">
      <button onclick="loadFlowList()" class="btn btn-primary">ğŸ” æŸ¥è¯¢</button>
    </div>
    <div class="col-auto">
      <button onclick="resetFlowSearch()" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
    </div>
    <div class="col-auto">
      <button onclick="exportFlowList()" class="btn btn-success">â¬‡ï¸ å¯¼å‡º</button>
    </div>
  </div>

  <div id="stationData">åŠ è½½ä¸­...</div>
  <div id="pagination" class="mt-3"></div>

  <!-- æ›²çº¿å›¾å¼¹çª— -->
  <div id="curveModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ğŸ“ˆ å®¢æµé¢„æµ‹æ›²çº¿</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="curveChart" style="height: 300px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentPage = 1;
let totalItems = 0;
const pageSize = 10;

function loadFlowList(page = 1) {
  const keyword = document.getElementById('searchInput').value;
  const date = document.getElementById('dateInput').value;
  const clock = document.getElementById('clockInput').value;

  fetch(`/getcurrentflow?date=${date}&clock=${clock}&keyword=${keyword}&page=${page}&size=${pageSize}`)
    .then(res => res.json())
    .then(res => {
      if (res.status === 'success') {
        const data = res.data;
        totalItems = res.total;
        currentPage = page;
        let html = `<table class='table table-bordered table-hover'><thead class='table-light'><tr><th>åºå·</th><th>å®¢æµç‚¹ä½</th><th>é¢„æµ‹äººæ•°</th><th>å®é™…äººæ•°</th><th>æ›´æ–°æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>`;
        html += data.map(row => `
          <tr>
            <td>${row.id}</td>
            <td>${row.name}</td>
            <td>${row.predict}</td>
            <td>${row.real}</td>
            <td>${row.time}</td>
            <td>
              <button class='btn btn-outline-info btn-sm' onclick=\"showCurve('${row.name}')\">æ›²çº¿å›¾</button>
              <button class='btn btn-outline-secondary btn-sm' onclick=\"loadFlowList(${currentPage})\">æ›´æ–°</button>
            </td>
          </tr>`).join('') + '</tbody></table>';
        document.getElementById('stationData').innerHTML = html;
        renderPagination();
      } else {
        document.getElementById('stationData').textContent = 'åŠ è½½å¤±è´¥';
      }
    });
}

function renderPagination() {
  const totalPages = Math.ceil(totalItems / pageSize);
  const container = document.getElementById('pagination');
  container.innerHTML = `å…± ${totalItems} æ¡æ•°æ®ï¼š `;
  for (let i = 1; i <= totalPages; i++) {
    container.innerHTML += `<button class='btn btn-sm ${i === currentPage ? "btn-primary" : "btn-outline-primary"}' style='margin: 2px;' onclick='loadFlowList(${i})'>${i}</button>`;
  }
}

function resetFlowSearch() {
  document.getElementById('searchInput').value = '';
  document.getElementById('dateInput').value = '';
  document.getElementById('clockInput').value = '10:00';
  loadFlowList(1);
}

function exportFlowList() {
  const rows = document.querySelectorAll('#stationData table tbody tr');
  if (!rows.length) return alert('æš‚æ— æ•°æ®');
  let csv = 'åºå·,å®¢æµç‚¹ä½,é¢„æµ‹äººæ•°,å®é™…äººæ•°,æ›´æ–°æ—¶é—´'
  rows.forEach(row => {
    const cols = row.querySelectorAll('td');
    csv += [...cols].slice(0, 5).map(td => td.innerText).join(',') + ''
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'äººæµé‡åˆ—è¡¨.csv';
  a.click();
  URL.revokeObjectURL(url);
}



function showCurve(station) {
  const date = document.getElementById('dateInput').value;
  const clock = document.getElementById('clockInput').value;

  if (!date || !clock) {
    alert('è¯·å…ˆé€‰æ‹©æ—¥æœŸå’Œæ—¶é—´');
    return;
  }

  fetch(`/getflowcurve?station=${station}&date=${date}&clock=${clock}`)
    .then(res => res.json())
    .then(res => {
      if (res.status === 'success') {
        const chart = echarts.init(document.getElementById('curveChart'));
        chart.clear(); // æ¸…é™¤ä¸Šä¸€æ¬¡çš„å›¾è¡¨
        chart.setOption({
          title: {
            text: `${station} - æœ€è¿‘ä¸€å‘¨é¢„æµ‹ä¸çœŸå®å€¼`,
            left: 'center'
          },
          tooltip: { trigger: 'axis' },
          legend: { top: 'bottom', data: ['é¢„æµ‹', 'å®é™…'] },
          xAxis: {
            type: 'category',
            data: res.data.map(item => item.date)
          },
          yAxis: {
            type: 'value',
            name: 'äººæ•°'
          },
          series: [
            {
              name: 'é¢„æµ‹',
              type: 'line',
              data: res.data.map(item => item.predict),
              smooth: true
            },
            {
              name: 'å®é™…',
              type: 'line',
              data: res.data.map(item => item.gt),
              smooth: true
            }
          ]
        });
        // âœ… æ˜¾ç¤ºå¼¹çª—
        new bootstrap.Modal(document.getElementById('curveModal')).show();
      } else {
        alert("åç«¯è¿”å›é”™è¯¯ï¼š" + res.message);
      }
    })
    .catch(err => {
      console.error("è¯·æ±‚é”™è¯¯ï¼š", err);
      alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ¥å£ã€‚");
    });
}






// åˆæ¬¡åŠ è½½
loadFlowList();
</script>
  </div>

<script>
function switchSection(id) {
  ['dashboard', 'list'].forEach(s => {
    document.getElementById(s).classList.remove('active-section');
    document.getElementById('nav-' + s).classList.remove('active');
  });
  document.getElementById(id).classList.add('active-section');
  document.getElementById('nav-' + id).classList.add('active');
}

// æ€§åˆ«æ¯”ä¾‹å›¾
const pie = echarts.init(document.getElementById('pieChart'));
pie.setOption({
  tooltip: { trigger: 'item', formatter: '{b}: {c} äºº ({d}%)' },
  legend: { top: 'bottom' },
  series: [{
    type: 'pie',
    radius: ['50%', '70%'],
    label: {
      show: true,
      formatter: '{b}: {c}äºº ({d}%)',
      position: 'outside'
    },
    data: [
      { value: 270, name: 'å¥³æ€§', itemStyle: { color: '#73c0de' } },
      { value: 330, name: 'ç”·æ€§', itemStyle: { color: '#5470c6' } }
    ]
  }]
});

// æŠ˜çº¿å›¾
const line = echarts.init(document.getElementById('lineChart'));
line.setOption({
  tooltip: { trigger: 'axis' },
  xAxis: {
    type: 'category',
    boundaryGap: false,
    data: [
      '00:00','01:00','02:00','03:00','04:00','05:00','06:00','07:00','08:00','09:00','10:00','11:00',
      '12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00'
    ]
  },
  yAxis: { type: 'value' },
  series: [{
    name: 'å®¢æµé‡',
    type: 'line',
    smooth: true,
    data: [120,100,90,80,75,70,95,200,300,380,420,450,500,480,470,430,410,390,350,300,260,200,150,100]
  }]
});
</script>
  
<div class="modal fade" id="curveModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ğŸ“ˆ å®¢æµé¢„æµ‹æ›²çº¿</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="curveChart" style="height: 400px;"></div>
        </div>
      </div>
    </div>
  </div>
  
</body>
</html>
